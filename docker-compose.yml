version: "3.9"

services:
  certs:
    image: alpine:3.20
    container_name: rts-certs
    volumes:
      - ./nginx/certs:/certs
    command:
      [
        "sh",
        "-c",
        "apk add --no-cache openssl >/dev/null && if [ ! -f /certs/server.crt ] || [ ! -f /certs/server.key ]; then openssl req -x509 -nodes -newkey rsa:2048 -days 365 -subj \"/CN=localhost\" -keyout /certs/server.key -out /certs/server.crt; fi",
      ]

  app:
    build:
      context: .
      target: development
    container_name: rts-app
    command: ["air", "-c", ".air.toml"]
    volumes:
      - .:/app
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
    environment:
      GO_ENV: development
      DATABASE_URL: postgres://rts_user:rts_password@pgpool:5432/rts_db?sslmode=disable
      REDIS_URL: redis://redis:6379/0
      WEBHOOK_URL: https://localhost:8443
      TELEGRAM_TOKEN: ${TELEGRAM_TOKEN:-}
      WEBHOOK_CERT: /app/nginx/certs/server.crt
      ADMIN_TOKEN: ${ADMIN_TOKEN:-}
    ports:
      - "8080:8080"
    depends_on:
      certs:
        condition: service_completed_successfully
      pgpool:
        condition: service_healthy
      redis:
        condition: service_healthy

  postgres-primary:
    image: bitnami/postgresql:15
    container_name: rts-postgres-primary
    environment:
      POSTGRESQL_USERNAME: rts_user
      POSTGRESQL_PASSWORD: rts_password
      POSTGRESQL_DATABASE: rts_db
      POSTGRESQL_REPLICATION_MODE: master
      POSTGRESQL_REPLICATION_USER: rts_repl
      POSTGRESQL_REPLICATION_PASSWORD: rts_repl_password
    ports:
      - "5432:5432"
    volumes:
      - postgres-primary-data:/bitnami/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rts_user -d rts_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-replica:
    image: bitnami/postgresql:15
    container_name: rts-postgres-replica
    depends_on:
      postgres-primary:
        condition: service_healthy
    environment:
      POSTGRESQL_REPLICATION_MODE: slave
      POSTGRESQL_REPLICATION_USER: rts_repl
      POSTGRESQL_REPLICATION_PASSWORD: rts_repl_password
      POSTGRESQL_MASTER_HOST: postgres-primary
      POSTGRESQL_MASTER_PORT_NUMBER: "5432"
      POSTGRESQL_PASSWORD: rts_password
    ports:
      - "5433:5432"
    volumes:
      - postgres-replica-data:/bitnami/postgresql

  pgpool:
    image: bitnami/pgpool:4
    container_name: rts-pgpool
    depends_on:
      postgres-primary:
        condition: service_healthy
      postgres-replica:
        condition: service_started
    environment:
      PGPOOL_BACKEND_NODES: "0:postgres-primary:5432,1:postgres-replica:5432"
      PGPOOL_SR_CHECK_USER: rts_repl
      PGPOOL_SR_CHECK_PASSWORD: rts_repl_password
      PGPOOL_POSTGRES_USERNAME: rts_user
      PGPOOL_POSTGRES_PASSWORD: rts_password
      PGPOOL_ADMIN_USERNAME: rts_admin
      PGPOOL_ADMIN_PASSWORD: rts_admin_password
      PGPOOL_ENABLE_LOAD_BALANCING: "yes"
      PGPOOL_ENABLE_STATEMENT_LOAD_BALANCING: "no"
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 5432 -U rts_user -d rts_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7
    container_name: rts-redis
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  nginx:
    image: nginx:1.27
    container_name: rts-nginx
    depends_on:
      certs:
        condition: service_completed_successfully
      - app
    ports:
      - "8443:443"
      - "8081:80"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/certs:/etc/nginx/certs:ro

  prometheus:
    image: prom/prometheus:v2.53.1
    container_name: rts-prometheus
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: rts-postgres-exporter
    environment:
      DATA_SOURCE_NAME: postgres://rts_user:rts_password@postgres-primary:5432/rts_db?sslmode=disable
    depends_on:
      postgres-primary:
        condition: service_healthy
    ports:
      - "9187:9187"

  grafana:
    image: grafana/grafana-oss:11.1.0
    container_name: rts-grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana

volumes:
  go-mod-cache:
  go-build-cache:
  postgres-primary-data:
  postgres-replica-data:
  redis-data:
  grafana-data:
